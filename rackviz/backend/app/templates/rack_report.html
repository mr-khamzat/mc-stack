<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Документация стойки</title>
  <style>
    @page {
      size: A4;
      margin: 14mm 12mm 14mm 12mm;
    }
    @page :right {
      @top-right { content: "RackViz  стр. " counter(page) " из " counter(pages); font-size: 7.5pt; color: #94a3b8; font-family: 'FreeSans', 'DejaVu Sans', sans-serif; }
    }
    @page :left {
      @top-left { content: "RackViz  стр. " counter(page) " из " counter(pages); font-size: 7.5pt; color: #94a3b8; font-family: 'FreeSans', 'DejaVu Sans', sans-serif; }
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'FreeSans', 'DejaVu Sans', Arial, sans-serif;
      font-size: 9.5pt;
      color: #1e293b;
      margin: 0;
      padding: 0;
    }

    /* ── Cover header ─────────────────────────────────── */
    .cover-header {
      border-bottom: 3px solid #2563eb;
      padding-bottom: 6mm;
      margin-bottom: 5mm;
    }
    .cover-title {
      font-size: 20pt;
      font-weight: bold;
      color: #1e3a8a;
      margin: 0 0 1.5mm 0;
      letter-spacing: -0.3pt;
    }
    .cover-subtitle {
      font-size: 9.5pt;
      color: #64748b;
      margin: 0;
    }

    /* ── Stats ─────────────────────────────────────────── */
    .stats-row {
      display: flex;
      gap: 4mm;
      margin: 5mm 0;
    }
    .stat-box {
      flex: 1;
      border: 1.5px solid #e2e8f0;
      border-radius: 3px;
      padding: 3mm 2mm;
      text-align: center;
      background: #f8fafc;
    }
    .stat-value {
      font-size: 16pt;
      font-weight: bold;
      color: #1e3a8a;
      line-height: 1.1;
    }
    .stat-label {
      font-size: 7pt;
      color: #64748b;
      margin-top: 1mm;
      line-height: 1.2;
    }

    /* ── Section title ─────────────────────────────────── */
    .section-title {
      font-size: 12pt;
      font-weight: bold;
      color: #1e3a8a;
      border-bottom: 2px solid #bfdbfe;
      padding-bottom: 1.5mm;
      margin: 6mm 0 3mm 0;
    }

    /* ── Rack visualization ────────────────────────────── */
    .rack-visual-wrap {
      display: flex;
      gap: 2mm;
      margin-bottom: 4mm;
    }
    .rack-u-labels {
      display: flex;
      flex-direction: column;
      padding-top: 2mm;
    }
    .rack-u-label {
      font-size: 6.5pt;
      color: #94a3b8;
      text-align: right;
      padding-right: 1.5mm;
    }
    .rack-body {
      flex: 1;
      border: 2px solid #475569;
      border-radius: 3px;
      background: #0f172a;
      padding: 2mm 2mm;
    }
    .rack-row {
      display: flex;
      align-items: center;
      border-radius: 2px;
      margin-bottom: 1.5px;
      padding: 0 3mm;
    }
    .rack-row-unit {
      font-size: 6.5pt;
      color: rgba(255,255,255,0.4);
      width: 8mm;
      flex-shrink: 0;
    }
    .rack-row-name {
      font-size: 8pt;
      font-weight: bold;
      color: #fff;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
    }
    .rack-row-meta {
      font-size: 6.5pt;
      color: rgba(255,255,255,0.55);
      flex-shrink: 0;
      margin-left: 2mm;
    }
    .rack-row-ports {
      display: flex;
      flex-wrap: wrap;
      gap: 1px;
      flex-shrink: 0;
      margin-left: 2mm;
      max-width: 40mm;
    }
    .port-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
    }
    .port-dot-free    { background: #334155; }
    .port-dot-online  { background: #16a34a; }
    .port-dot-offline { background: #ca8a04; }
    .port-dot-custom  { background: #2563eb; }
    .port-dot-manual  { background: #7c3aed; }

    /* ── Device section ────────────────────────────────── */
    .device-section {
      margin-bottom: 5mm;
      border: 1.5px solid #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      page-break-inside: avoid;
    }
    .device-header {
      display: flex;
      align-items: center;
      padding: 3mm 4mm;
      gap: 3mm;
    }
    .device-header-name {
      font-size: 11pt;
      font-weight: bold;
      color: #fff;
      flex: 1;
    }
    .device-header-meta {
      font-size: 7.5pt;
      color: rgba(255,255,255,0.7);
    }
    .device-notes {
      background: #fef9c3;
      padding: 1.5mm 4mm;
      font-size: 8.5pt;
      color: #78350f;
      border-bottom: 1px solid #fde68a;
    }
    .device-port-summary {
      background: #f8fafc;
      padding: 1.5mm 4mm;
      font-size: 7.5pt;
      color: #64748b;
      border-bottom: 1px solid #e2e8f0;
    }
    .no-occupied {
      padding: 3mm 4mm;
      color: #94a3b8;
      font-size: 8.5pt;
      font-style: italic;
    }

    /* ── Port table ────────────────────────────────────── */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 8pt;
    }
    th {
      background: #f1f5f9;
      color: #475569;
      font-weight: bold;
      padding: 1.5mm 2mm;
      text-align: left;
      border-bottom: 1.5px solid #cbd5e1;
      font-size: 7.5pt;
      white-space: nowrap;
    }
    td {
      padding: 1.3mm 2mm;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }
    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) { background: #fafafa; }
    .td-portnum {
      color: #64748b;
      font-weight: bold;
      white-space: nowrap;
      width: 9mm;
    }
    .td-type {
      color: #64748b;
      white-space: nowrap;
      width: 12mm;
    }

    .badge {
      display: inline-block;
      padding: 0.3mm 1.5mm;
      border-radius: 2px;
      font-size: 7pt;
      font-weight: bold;
      white-space: nowrap;
    }
    .badge-mc-online  { background: #dcfce7; color: #15803d; }
    .badge-mc-offline { background: #fef9c3; color: #92400e; }
    .badge-custom     { background: #dbeafe; color: #1d4ed8; }
    .badge-manual     { background: #f3e8ff; color: #7e22ce; }
    .badge-free       { background: #f1f5f9; color: #94a3b8; }

    .mono { font-family: 'FreeMono', 'DejaVu Sans Mono', monospace; font-size: 7.5pt; }
    .dash { color: #cbd5e1; }

    /* ── Recommendations ───────────────────────────────── */
    .recommendations {
      page-break-before: always;
    }
    .rec-item {
      display: flex;
      gap: 3mm;
      margin-bottom: 3mm;
      padding: 3mm;
      border-left: 3px solid #2563eb;
      background: #eff6ff;
      border-radius: 0 3px 3px 0;
    }
    .rec-marker {
      font-size: 8pt;
      font-weight: bold;
      color: #2563eb;
      width: 5mm;
      flex-shrink: 0;
      padding-top: 0.3mm;
    }
    .rec-content { flex: 1; }
    .rec-title { font-size: 10pt; font-weight: bold; color: #1e3a8a; margin-bottom: 1mm; }
    .rec-desc  { font-size: 8.5pt; color: #475569; line-height: 1.4; }

    .rec-item-warn {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    .rec-item-warn .rec-marker { color: #f59e0b; }
    .rec-item-warn .rec-title  { color: #92400e; }

    .rec-item-ok {
      border-left-color: #16a34a;
      background: #f0fdf4;
    }
    .rec-item-ok .rec-marker { color: #16a34a; }
    .rec-item-ok .rec-title  { color: #166534; }

    /* ── Footer ────────────────────────────────────────── */
    .footer-note {
      margin-top: 8mm;
      padding-top: 3mm;
      border-top: 1px solid #e2e8f0;
      font-size: 7.5pt;
      color: #94a3b8;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- ═══════════════════════════════════════════════════
       ШАПКА / COVER
       ═══════════════════════════════════════════════════ -->
  <div class="cover-header">
    <div class="cover-title">Документация стойки</div>
    <div class="cover-subtitle">Сформировано {{ generated_at }} &nbsp;|&nbsp; RackViz</div>
  </div>

  <!-- ═══════════════════════════════════════════════════
       СТАТИСТИКА
       ═══════════════════════════════════════════════════ -->
  <div class="stats-row">
    <div class="stat-box">
      <div class="stat-value">{{ stats.total_devices }}</div>
      <div class="stat-label">Устройств</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">{{ stats.total_units }}U</div>
      <div class="stat-label">Занято в стойке</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">{{ stats.total_ports }}</div>
      <div class="stat-label">Портов всего</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" style="color:#16a34a;">{{ stats.occupied_ports }}</div>
      <div class="stat-label">Занято портов</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" style="color:#94a3b8;">{{ stats.free_ports }}</div>
      <div class="stat-label">Свободно портов</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" style="color:{% if stats.mc_online > 0 %}#16a34a{% else %}#94a3b8{% endif %};">{{ stats.mc_online }}</div>
      <div class="stat-label">MC онлайн</div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════
       СХЕМА СТОЙКИ
       ═══════════════════════════════════════════════════ -->
  <div class="section-title">Схема стойки</div>

  <div class="rack-body">
    {% for dev in devices %}
    {% set h_mm = dev.unit_size * 8 %}
    <div class="rack-row" style="background:{{ dev.color }}; min-height:{{ h_mm }}mm; height:{{ h_mm }}mm;">
      <div class="rack-row-unit">U{{ dev.rack_unit }}{% if dev.unit_size > 1 %}-{{ dev.rack_unit + dev.unit_size - 1 }}{% endif %}</div>
      <div class="rack-row-name">{{ dev.name }}</div>
      {% if dev.brand or dev.model %}
      <div class="rack-row-meta">{{ dev.brand or '' }}{% if dev.brand and dev.model %} {{ dev.model }}{% elif dev.model %}{{ dev.model }}{% endif %}</div>
      {% endif %}
      <div class="rack-row-ports">
        {% for port in dev.ports %}
          {% if port.source_type == 'mc' and port.mc_node_online == 1 %}
            <div class="port-dot port-dot-online" title="MC онлайн"></div>
          {% elif port.source_type == 'mc' %}
            <div class="port-dot port-dot-offline" title="MC офлайн"></div>
          {% elif port.source_type == 'custom' %}
            <div class="port-dot port-dot-custom" title="Устройство"></div>
          {% elif port.source_type == 'manual' %}
            <div class="port-dot port-dot-manual" title="Ручной"></div>
          {% else %}
            <div class="port-dot port-dot-free"></div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ═══════════════════════════════════════════════════
       ДЕТАЛИ УСТРОЙСТВ
       ═══════════════════════════════════════════════════ -->
  <div class="section-title" style="margin-top:7mm;">Детали устройств и подключений</div>

  {% for dev in devices %}
  {% set occupied = dev.ports | selectattr('source_type', 'ne', 'free') | list %}
  {% set free_cnt = dev.ports | selectattr('source_type', 'equalto', 'free') | list | length %}

  <div class="device-section">

    <!-- Header bar (device colour) -->
    <div class="device-header" style="background:{{ dev.color }};">
      <div class="device-header-name">{{ dev.name }}</div>
      <div class="device-header-meta">
        {{ dev.device_type | upper }}
        {% if dev.brand %} &middot; {{ dev.brand }}{% endif %}
        {% if dev.model %} {{ dev.model }}{% endif %}
        &middot; U{{ dev.rack_unit }}{% if dev.unit_size > 1 %}&ndash;{{ dev.rack_unit + dev.unit_size - 1 }}{% endif %}
        ({{ dev.unit_size }}U)
        &middot; {{ dev.port_count }} портов
      </div>
    </div>

    {% if dev.notes %}
    <div class="device-notes">Заметки: {{ dev.notes }}</div>
    {% endif %}

    <div class="device-port-summary">
      Занято: {{ occupied | length }}
      &nbsp;&nbsp;
      Свободно: {{ free_cnt }}
      &nbsp;&nbsp;
      {% set mc_on  = dev.ports | selectattr('source_type', 'equalto', 'mc') | selectattr('mc_node_online', 'equalto', 1) | list | length %}
      {% set mc_off = dev.ports | selectattr('source_type', 'equalto', 'mc') | selectattr('mc_node_online', 'ne', 1)  | list | length %}
      {% if mc_on > 0 %}MC онлайн: {{ mc_on }}&nbsp;&nbsp;{% endif %}
      {% if mc_off > 0 %}MC офлайн: {{ mc_off }}&nbsp;&nbsp;{% endif %}
    </div>

    {% if occupied %}
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Тип</th>
          <th>Статус</th>
          <th>Метка / Узел</th>
          <th>IP адрес</th>
          <th>MAC адрес</th>
          <th>Описание</th>
        </tr>
      </thead>
      <tbody>
        {% for port in occupied %}
        <tr>
          <td class="td-portnum">{{ port.port_number }}</td>
          <td class="td-type">{{ port.port_type }}</td>
          <td>
            {% if port.source_type == 'mc' %}
              {% if port.mc_node_online == 1 %}
                <span class="badge badge-mc-online">MC онлайн</span>
              {% else %}
                <span class="badge badge-mc-offline">MC офлайн</span>
              {% endif %}
            {% elif port.source_type == 'custom' %}
              <span class="badge badge-custom">Устройство</span>
            {% elif port.source_type == 'manual' %}
              <span class="badge badge-manual">Ручной</span>
            {% else %}
              <span class="badge badge-free">Свободен</span>
            {% endif %}
          </td>
          <td>
            {% if port.source_type == 'mc' %}
              {{ port.mc_node_name or '&mdash;' }}
            {% elif port.manual_label %}
              {{ port.manual_label }}
            {% elif port.label %}
              {{ port.label }}
            {% else %}
              <span class="dash">&mdash;</span>
            {% endif %}
          </td>
          <td class="mono">{{ port.manual_ip or '<span class="dash">&mdash;</span>' }}</td>
          <td class="mono">{{ port.manual_mac or '<span class="dash">&mdash;</span>' }}</td>
          <td>{{ port.manual_desc or port.description or '<span class="dash">&mdash;</span>' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="no-occupied">Все порты свободны</div>
    {% endif %}

  </div>
  {% endfor %}

  <!-- ═══════════════════════════════════════════════════
       РЕКОМЕНДАЦИИ
       ═══════════════════════════════════════════════════ -->
  <div class="recommendations">
    <div class="section-title">Рекомендации по настройке и эксплуатации стойки</div>

    <!-- Dynamic recommendations based on rack state -->
    {% for rec in dynamic_recs %}
    <div class="rec-item{% if rec.kind == 'warn' %} rec-item-warn{% elif rec.kind == 'ok' %} rec-item-ok{% endif %}">
      <div class="rec-marker">{% if rec.kind == 'warn' %}!{% elif rec.kind == 'ok' %}v{% else %}i{% endif %}</div>
      <div class="rec-content">
        <div class="rec-title">{{ rec.title }}</div>
        <div class="rec-desc">{{ rec.desc }}</div>
      </div>
    </div>
    {% endfor %}

    <!-- Static best-practice recommendations -->
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Маркировка кабелей</div>
        <div class="rec-desc">Каждый патч-корд должен иметь маркировку с номером порта источника и назначения. Рекомендуется цветовое кодирование: синий — данные, красный — management, жёлтый — uplink, серый — свободно.</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Управление кабелями (Cable management)</div>
        <div class="rec-desc">Устанавливайте горизонтальный кабель-менеджер (1U) между коммутаторами для аккуратной укладки патч-кордов. При заполненности более 48 портов рекомендуется вертикальный Cable Manager.</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Документирование изменений в реальном времени</div>
        <div class="rec-desc">Любое изменение подключения должно немедленно отражаться в RackViz. Назначайте портам описание (IP, имя узла, назначение) — это сокращает время диагностики при инцидентах в несколько раз.</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Охлаждение и размещение оборудования</div>
        <div class="rec-desc">Серверы и активное оборудование размещайте в нижней части стойки, патч-панели и пассивное оборудование — в верхней. Обеспечьте зазор 1U&ndash;2U между мощными активными устройствами для конвекции воздуха. Используйте заглушки 1U на пустых позициях для правильного воздушного потока.</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Безопасность сети — неиспользуемые порты</div>
        <div class="rec-desc">Все свободные порты коммутатора должны быть административно заблокированы (shutdown на управляемых коммутаторах). Для неуправляемых сегментов применяйте контроль доступа по MAC-адресу (802.1X или port security).</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Резервирование портов и планирование роста</div>
        <div class="rec-desc">Резервируйте 15&ndash;20% портов и rack unit'ов для будущих подключений. При заполненности выше 80% начинайте планировать расширение. Предпочтительно использовать коммутаторы с возможностью стекирования (stacking) для масштабирования без простоев.</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Электропитание и резервирование ИБП</div>
        <div class="rec-desc">Коммутаторы и критичное оборудование должны быть подключены к ИБП (UPS) с мощностью с запасом не менее 30% от суммарной нагрузки. Используйте PDU с мониторингом нагрузки на каждую розетку.</div>
      </div>
    </div>
    <div class="rec-item">
      <div class="rec-marker">+</div>
      <div class="rec-content">
        <div class="rec-title">Мониторинг доступности (MeshCentral / SNMP)</div>
        <div class="rec-desc">Для всех серверов и рабочих станций в стойке установите агент MeshCentral — это даёт удалённый доступ и мониторинг. Для сетевых устройств настройте SNMP-мониторинг (Zabbix, Prometheus SNMP Exporter) для контроля загрузки портов и CPU.</div>
      </div>
    </div>

  </div>

  <div class="footer-note">
    Документ сформирован автоматически системой RackViz &nbsp;&middot;&nbsp; {{ generated_at }}
  </div>

</body>
</html>
